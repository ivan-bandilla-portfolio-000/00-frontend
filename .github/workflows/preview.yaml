name: Vercel Preview Deployment

env:
    VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
    VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

on:
    push:
        branches:
            - dev

jobs:
    Deploy-Preview:
        if: ${{ !contains(github.event.head_commit.message, '[skip preview]') }}
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v3

            - name: Wait for CodeQL workflow run for this commit
              env:
                GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                set -euo pipefail
                owner_repo="$GITHUB_REPOSITORY"
                owner="${owner_repo%/*}"
                repo="${owner_repo#*/}"
                sha="$GITHUB_SHA"

                sudo apt-get update -y
                sudo apt-get install -y jq

                # find the workflow id for any workflow whose name/path contains "codeql" (case-insensitive)
                workflows_resp=$(curl -s -H "Authorization: token $GITHUB_TOKEN" "https://api.github.com/repos/$owner/$repo/actions/workflows?per_page=100")
                workflow_id=$(echo "$workflows_resp" | jq -r '.workflows[] | select((.name // "" | ascii_downcase | test("codeql")) or (.path // "" | ascii_downcase | test("codeql"))) | .id' | head -n1 || true)

                if [ -z "$workflow_id" ]; then
                  echo "No CodeQL workflow found in repository workflows list. Dumping workflows for debug:"
                  echo "$workflows_resp" | jq -r '.workflows[] | "\(.id) \(.name) \(.path)"'
                  exit 1
                fi

                echo "Using CodeQL workflow id: $workflow_id"

                attempts=40   # ~40 * 15s = 600s (10 minutes)
                interval=15
                count=0

                while [ $count -lt $attempts ]; do
                  resp=$(curl -s -H "Authorization: token $GITHUB_TOKEN" "https://api.github.com/repos/$owner/$repo/actions/workflows/$workflow_id/runs?head_sha=$sha&per_page=100")
                  # debug: list runs for this workflow & sha
                  if [ $count -eq 0 ]; then
                    echo "Workflow runs for workflow_id $workflow_id and sha $sha:"
                    echo "$resp" | jq -r '.workflow_runs[] | "\(.id) \(.head_sha) \(.status) \(.conclusion) \(.html_url) \(.name)"' || true
                  fi

                  run_entry=$(echo "$resp" | jq -r '.workflow_runs[0] // empty | @base64' || true)

                  if [ -n "$run_entry" ]; then
                    decoded=$(echo "$run_entry" | base64 --decode)
                    status=$(echo "$decoded" | jq -r '.status')
                    conclusion=$(echo "$decoded" | jq -r '.conclusion')
                    echo "Found CodeQL run: status=$status conclusion=$conclusion"
                    if [ "$status" = "completed" ]; then
                      if [ "$conclusion" = "success" ]; then
                        echo "CodeQL succeeded for commit $sha"
                        break
                      else
                        echo "CodeQL finished with conclusion: $conclusion"
                        exit 1
                      fi
                    fi
                  else
                    echo "No CodeQL run found for commit $sha yet (workflow id: $workflow_id)"
                  fi

                  count=$((count+1))
                  sleep $interval
                done

                if [ $count -ge $attempts ]; then
                  echo "Timed out waiting for CodeQL run to complete"
                  exit 1
                fi

            - name: Install dependencies
              run: npm ci

            - name: Install Vercel CLI
              run: npm install --global vercel

            - name: Pull Vercel Project Settings
              run: vercel pull --yes --environment=preview --token=${{ secrets.VERCEL_TOKEN }}

            - name: Pull Vercel Environment Information
              run: vercel env pull --yes --environment=preview --token=${{ secrets.VERCEL_TOKEN }}

            - name: Build Project Artifacts
              run: vercel build --token=${{ secrets.VERCEL_TOKEN }}

            - name: Deploy Project Artifacts
              run: vercel deploy --prebuilt --token=${{ secrets.VERCEL_TOKEN }}